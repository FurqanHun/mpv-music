#!/usr/bin/env bash
# File: mpv-music-updater
# Usage: ./mpv-music-updater <path_to_existing_script>

set -euo pipefail

TARGET_PATH="$1"
# REPO_BASE="https://raw.githubusercontent.com/FurqanHun/mpv-music/master"
API_URL="https://api.github.com/repos/FurqanHun/mpv-music/releases"
TEMP_DOWNLOAD="$HOME/.config/mpv-music/mpv-music.new"
CONFIG_DIR="$HOME/.config/mpv-music"

# --- Colors & Helpers ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

msg_info()  { echo -e "${BLUE}[INFO]${NC}  $1"; }
msg_ok()    { echo -e "${GREEN}[OK]${NC}    $1"; }
msg_warn()  { echo -e "${YELLOW}[WARN]${NC}  $1"; }
msg_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# --- SELF-DESTRUCT TRAP ---
# Ensure this script deletes itself regardless of success or failure
cleanup() {
    rm -f "$0"
}
trap cleanup EXIT

msg_info "Checking for updates..."

if ! LATEST_JSON=$(curl -sL "$API_URL"); then
    msg_error "Failed to check for updates (API request failed)."
    exit 1
fi

# Use jq to grab the FIRST item in the array (.[0])
# This works for pre-releases, drafts, stable, everything.
LATEST_TAG=$(echo "$LATEST_JSON" | jq -r '.[0].tag_name // empty')

if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
    msg_error "Could not find a valid tag in the release list."
    exit 1
fi

REMOTE_VERSION="${LATEST_TAG#v}"

if [[ -f "$TARGET_PATH" ]]; then
    CURRENT_VERSION=$(grep '^VERSION=' "$TARGET_PATH" | cut -d'"' -f2)
else
    CURRENT_VERSION="0.0.0"
fi

# --- VERSION COMPARISON LOGIC ---

if [[ "$REMOTE_VERSION" == "$CURRENT_VERSION" ]]; then
    msg_ok "You are already using the latest version (v$CURRENT_VERSION)."
    exit 0
fi

# Downgrade Prevention
# Sort versions numerically/semantically.
# If the smallest (top) version is the REMOTE one, we are already newer.
SMALLEST_VERSION=$(echo -e "${CURRENT_VERSION}\n${REMOTE_VERSION}" | sort -V | head -n1)

if [[ "$SMALLEST_VERSION" == "$REMOTE_VERSION" ]]; then
    msg_ok "You are running a newer version (v$CURRENT_VERSION) than the release (v$REMOTE_VERSION)."
    msg_info "Skipping downgrade."
    exit 0
fi

msg_warn "Update found! v$CURRENT_VERSION -> v$REMOTE_VERSION"
msg_info "Fetching release $LATEST_TAG..."

# Construct the download link using the specific tag
DOWNLOAD_URL="https://raw.githubusercontent.com/FurqanHun/mpv-music/${LATEST_TAG}/mpv-music"

if ! curl -sL "$DOWNLOAD_URL" -o "$TEMP_DOWNLOAD"; then
    msg_error "Failed to download the update."
    exit 1
fi

chmod +x "$TEMP_DOWNLOAD"

if ! grep -q "bash" "$TEMP_DOWNLOAD"; then
    msg_error "Downloaded file seems corrupt."
    rm "$TEMP_DOWNLOAD"
    exit 1
fi

if mv "$TEMP_DOWNLOAD" "$TARGET_PATH"; then
    msg_ok "Update to v$REMOTE_VERSION successful!"

    # --- MIGRATION CHECK (JSON -> JSONL) ---
        # Check if the OLD index format exists.
        if [[ -f "$CONFIG_DIR/music_index.json" ]]; then
            echo ""
            msg_warn "Legacy database format detected (.json)."
            msg_warn "v0.15.0 update introduced a faster engine (.jsonl)."

            echo -e "${YELLOW}Your library will automatically migrate to the new format the next time you run mpv-music.${NC}"
            echo -e "${YELLOW}The old .json file will be removed upon success.${NC}"
        fi
else
    msg_error "Failed to replace file. Check permissions."
    rm "$TEMP_DOWNLOAD"
    exit 1
fi
