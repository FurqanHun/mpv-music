#!/usr/bin/env bash
# File: mpv-music-updater
# Usage: ./mpv-music-updater <path_to_existing_script>

set -euo pipefail

TARGET_PATH="$1"
REPO_BASE="https://raw.githubusercontent.com/FurqanHun/mpv-music/master"
TEMP_DOWNLOAD="$HOME/.config/mpv-music/mpv-music.new"


GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- SELF-DESTRUCT TRAP ---
# Ensure this script deletes itself regardless of success or failure
cleanup() {
    rm -f "$0"
}
trap cleanup EXIT

echo "Fetching the latest version metadata..."

if ! curl -sL "$REPO_BASE/mpv-music" -o "$TEMP_DOWNLOAD"; then
    echo -e "${RED}Error: Failed to download the new script.${NC}"
    exit 1
fi

NEW_VERSION=$(grep '^VERSION=' "$TEMP_DOWNLOAD" | cut -d'"' -f2)
CURRENT_VERSION=$(grep '^VERSION=' "$TARGET_PATH" | cut -d'"' -f2)

if [[ "$NEW_VERSION" == "$CURRENT_VERSION" ]]; then
    echo -e "${GREEN}You are already using the latest version (v$CURRENT_VERSION).${NC}"
    rm "$TEMP_DOWNLOAD"
    exit 0
fi

echo -e "${YELLOW}Update found! v$CURRENT_VERSION -> v$NEW_VERSION${NC}"

chmod +x "$TEMP_DOWNLOAD"

if ! grep -q "bash" "$TEMP_DOWNLOAD"; then
    echo -e "${RED}Error: Downloaded file seems corrupt.${NC}"
    rm "$TEMP_DOWNLOAD"
    exit 1
fi

# echo "Replacing $TARGET_PATH..."
if mv "$TEMP_DOWNLOAD" "$TARGET_PATH"; then
    echo -e "${GREEN}Update to v$NEW_VERSION successful!${NC}"
    # echo "$TARGET_PATH is now v$NEW_VERSION"
else
    echo -e "${RED}Error: Failed to replace file. Check permissions.${NC}"
    rm "$TEMP_DOWNLOAD"
    exit 1
fi
