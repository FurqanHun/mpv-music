#!/usr/bin/env bash
# File: mpv-music-updater
# Usage: ./mpv-music-updater <path_to_existing_script>

set -euo pipefail

TARGET_PATH="$1"
# REPO_BASE="https://raw.githubusercontent.com/FurqanHun/mpv-music/master"
API_URL="https://api.github.com/repos/FurqanHun/mpv-music/releases"
TEMP_DOWNLOAD="$HOME/.config/mpv-music/mpv-music.new"

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# --- SELF-DESTRUCT TRAP ---
# Ensure this script deletes itself regardless of success or failure
cleanup() {
    rm -f "$0"
}
trap cleanup EXIT

echo "Checking for updates..."

if ! LATEST_JSON=$(curl -sL "$API_URL"); then
    echo -e "${RED}Error: Failed to check for updates (API request failed).${NC}"
    exit 1
fi

# Use jq to grab the FIRST item in the array (.[0])
# This works for pre-releases, drafts, stable, everything.
LATEST_TAG=$(echo "$LATEST_JSON" | jq -r '.[0].tag_name // empty')

if [[ -z "$LATEST_TAG" || "$LATEST_TAG" == "null" ]]; then
    echo -e "${RED}Error: Could not find a valid tag in the release list.${NC}"
    exit 1
fi

REMOTE_VERSION="${LATEST_TAG#v}"

if [[ -f "$TARGET_PATH" ]]; then
    CURRENT_VERSION=$(grep '^VERSION=' "$TARGET_PATH" | cut -d'"' -f2)
else
    CURRENT_VERSION="0.0.0"
fi

if [[ "$REMOTE_VERSION" == "$CURRENT_VERSION" ]]; then
    echo -e "${GREEN}You are already using the latest version (v$CURRENT_VERSION).${NC}"
    exit 0
fi

echo -e "${YELLOW}Update found! v$CURRENT_VERSION -> v$REMOTE_VERSION${NC}"
echo "Fetching release $LATEST_TAG..."

# Construct the download link using the specific tag
DOWNLOAD_URL="https://raw.githubusercontent.com/FurqanHun/mpv-music/${LATEST_TAG}/mpv-music"

if ! curl -sL "$DOWNLOAD_URL" -o "$TEMP_DOWNLOAD"; then
    echo -e "${RED}Error: Failed to download the update.${NC}"
    exit 1
fi

chmod +x "$TEMP_DOWNLOAD"

if ! grep -q "bash" "$TEMP_DOWNLOAD"; then
    echo -e "${RED}Error: Downloaded file seems corrupt.${NC}"
    rm "$TEMP_DOWNLOAD"
    exit 1
fi

# echo "Replacing $TARGET_PATH..."
if mv "$TEMP_DOWNLOAD" "$TARGET_PATH"; then
    echo -e "${GREEN}Update to v$REMOTE_VERSION successful!${NC}"
    # echo "$TARGET_PATH is now v$NEW_VERSION"
else
    echo -e "${RED}Error: Failed to replace file. Check permissions.${NC}"
    rm "$TEMP_DOWNLOAD"
    exit 1
fi
