name: Manual Indexer Build (All Arch)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-upload:
    name: Build ${{ matrix.suffix }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Standard Desktop Linux (64-bit)
          - target: x86_64-unknown-linux-musl
            suffix: linux-x86_64

          # Raspberry Pi 4/5 / Asahi / ARM Servers (64-bit)
          - target: aarch64-unknown-linux-musl
            suffix: linux-aarch64

          # Older Raspberry Pi / Embedded (32-bit)
          - target: armv7-unknown-linux-musleabihf
            suffix: linux-armv7

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install 'cross' (The Magic Tool)
        run: |
          # Download pre-built cross binary (compiling it takes forever)
          curl -L --proto '=https' --tlsv1.2 -sSf https://github.com/cross-rs/cross/releases/download/v0.2.5/cross-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo mv cross /usr/local/bin/

      - name: Build with Cross
        run: |
          cd crates/mpv-music-indexer
          cross build --release --target ${{ matrix.target }}

      - name: Rename Binary
        run: |
          # Rename strictly for the release asset
          cp crates/mpv-music-indexer/target/${{ matrix.target }}/release/mpv-music-indexer mpv-music-indexer-${{ matrix.suffix }}

      - name: Upload to Latest Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the latest release tag dynamically via API
          # LATEST_TAG=$(gh release view --json tagName --jq .tagName)
          # pre-release
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')

          echo "Target: ${{ matrix.target }}"
          echo "Uploading to: $LATEST_TAG"

          # Upload and overwrite (--clobber) if it exists
          gh release upload "$LATEST_TAG" mpv-music-indexer-${{ matrix.suffix }} --clobber
